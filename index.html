<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Escaparate</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Mi Escaparate</h1>
            <p>Los mejores productos al mejor precio</p>
        </header>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Cargando productos...</p>
        </div>

        <div id="products-container" class="products-grid">
            <!-- Los productos se cargarán aquí dinámicamente -->
        </div>

        <div class="empty-state" id="empty-state" style="display: none;">
            <h2>¡Aún no hay productos!</h2>
            <p>Pronto habrá productos increíbles aquí</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, getDocs, onSnapshot, orderBy, query } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // TODO: Reemplaza con tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyArX8CmuYlHfMS62pUtYInOH-gtk_d5gdY",
            authDomain: "dajuco07-eb5e5.firebaseapp.com",
            projectId: "dajuco07-eb5e5",
            storageBucket: "dajuco07-eb5e5.firebasestorage.app",
            messagingSenderId: "591757692804",
            appId: "1:591757692804:web:dd31fb60c28dd0eaa357d1",
            measurementId: "G-DYGNBNQ3H9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let products = [];

        // Función para mostrar loading
        function showLoading(show = true) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'flex' : 'none';
        }

        // Función para mostrar productos en la página principal
        function displayProducts() {
            const container = document.getElementById('products-container');
            const emptyState = document.getElementById('empty-state');
            
            showLoading(false);
            
            if (products.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            container.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="image-carousel">
                        ${product.images.map((image, index) => `
                            <img src="${image}" alt="${product.name}" 
                                 class="carousel-image ${index === 0 ? 'active' : ''}"
                                 data-product="${product.id}" data-index="${index}">
                        `).join('')}
                        ${product.images.length > 1 ? `
                            <div class="carousel-nav">
                                ${product.images.map((_, index) => `
                                    <div class="nav-dot ${index === 0 ? 'active' : ''}"
                                         onclick="changeImage('${product.id}', ${index})"></div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${product.price.toFixed(2)}€</div>
                        <a href="${product.wallapopLink}" target="_blank" class="wallapop-btn">
                            Ver en Wallapop
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Función para cambiar imagen en el carrusel
        window.changeImage = function(productId, imageIndex) {
            const images = document.querySelectorAll(`[data-product="${productId}"]`);
            const dots = document.querySelectorAll(`[onclick*="${productId}"]`);
            
            images.forEach(img => img.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));
            
            if (images[imageIndex]) {
                images[imageIndex].classList.add('active');
            }
            if (dots[imageIndex]) {
                dots[imageIndex].classList.add('active');
            }
        };

        // Auto-cambio de imágenes en el carrusel cada 5 segundos
        function startAutoCarousel() {
            setInterval(() => {
                products.forEach(product => {
                    if (product.images.length > 1) {
                        const currentActive = document.querySelector(`[data-product="${product.id}"].active`);
                        if (currentActive) {
                            const currentIndex = parseInt(currentActive.dataset.index);
                            const nextIndex = (currentIndex + 1) % product.images.length;
                            changeImage(product.id, nextIndex);
                        }
                    }
                });
            }, 5000);
        }

        // Función para cargar productos desde Firebase
        async function loadProducts() {
            try {
                showLoading(true);
                
                // Escuchar cambios en tiempo real
                const q = query(collection(db, "products"), orderBy("dateAdded", "desc"));
                onSnapshot(q, (querySnapshot) => {
                    products = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        products.push({
                            id: doc.id,
                            ...data
                        });
                    });
                    displayProducts();
                }, (error) => {
                    console.error("Error loading products:", error);
                    showLoading(false);
                    // Mostrar mensaje de error amigable
                    const container = document.getElementById('products-container');
                    container.innerHTML = `
                        <div style="text-align: center; color: #e53e3e; padding: 40px;">
                            <h3>Error al cargar los productos</h3>
                            <p>Por favor, verifica tu conexión a internet y recarga la página.</p>
                            <button onclick="window.location.reload()" class="btn" style="margin-top: 20px;">
                                Recargar página
                            </button>
                        </div>
                    `;
                });
            } catch (error) {
                console.error("Error initializing products:", error);
                showLoading(false);
            }
        }

        // Cargar productos al iniciar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            startAutoCarousel();
        });
    </script>

    <style>
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>