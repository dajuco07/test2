<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Mi Escaparate</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Panel de Administración</h1>
            <p>Gestiona tus productos</p>
        </header>

        <div class="back-btn-container">
            <a href="index.html" class="back-btn">← Volver al Escaparate</a>
        </div>

        <!-- Modal de login admin -->
        <div id="login-modal" class="modal" style="display: block;">
            <div class="modal-content">
                <h2>Acceso de Administrador</h2>
                <div class="form-group">
                    <label for="admin-password">Contraseña:</label>
                    <input type="password" id="admin-password" placeholder="Ingresa la contraseña" onkeypress="handleEnterKey(event)">
                </div>
                <button class="btn" onclick="checkAdminPassword()">Acceder</button>
                <div id="error-message" class="error-message" style="display: none;">
                    Contraseña incorrecta
                </div>
            </div>
        </div>

        <!-- Contenido de administración (oculto inicialmente) -->
        <div id="admin-content" style="display: none;">
            <div class="admin-section">
                <h2>Añadir Nuevo Producto</h2>
                <form id="product-form" class="product-form">
                    <div class="form-group">
                        <label for="product-name">Nombre del Producto:</label>
                        <input type="text" id="product-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-price">Precio (€):</label>
                        <input type="number" id="product-price" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="wallapop-link">Enlace de Wallapop:</label>
                        <input type="url" id="wallapop-link" placeholder="https://es.wallapop.com/..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-images">Imágenes del Producto:</label>
                        <input type="file" id="product-images" class="file-input" multiple accept="image/*" onchange="previewImages()">
                        <small style="color: #666; font-size: 14px; margin-top: 5px; display: block;">
                            Puedes seleccionar hasta 10 imágenes. Máximo 2MB por imagen.
                            Formatos: JPG, PNG, GIF, WebP
                        </small>
                        <div id="image-preview" class="image-preview"></div>
                    </div>
                    
                    <button type="submit" class="btn">Añadir Producto</button>
                </form>
            </div>

            <div class="admin-section">
                <h2>Productos Existentes</h2>
                <div class="loading" id="admin-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Cargando productos...</p>
                </div>
                <div id="admin-products-list">
                    <!-- Lista de productos para administración -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, orderBy, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // TODO: Reemplaza con tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyArX8CmuYlHfMS62pUtYInOH-gtk_d5gdY",
        authDomain: "dajuco07-eb5e5.firebaseapp.com",
            projectId: "dajuco07-eb5e5",
            storageBucket: "dajuco07-eb5e5.firebasestorage.app",
            messagingSenderId: "591757692804",
            appId: "1:591757692804:web:dd31fb60c28dd0eaa357d1",
            measurementId: "G-DYGNBNQ3H9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Contraseña de administrador (cámbiala por la tuya)
        const ADMIN_PASSWORD = "admin123";

        let products = [];

        // Función para verificar contraseña admin
        window.checkAdminPassword = function() {
            const password = document.getElementById('admin-password').value;
            const errorMessage = document.getElementById('error-message');
            
            if (password === ADMIN_PASSWORD) {
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadAdminProducts();
                document.getElementById('admin-password').value = '';
                errorMessage.style.display = 'none';
            } else {
                errorMessage.style.display = 'block';
                document.getElementById('admin-password').value = '';
                // Hacer que el campo se agite para indicar error
                const passwordInput = document.getElementById('admin-password');
                passwordInput.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    passwordInput.style.animation = '';
                }, 500);
            }
        };

        // Función para manejar Enter en el campo de contraseña
        window.handleEnterKey = function(event) {
            if (event.key === 'Enter') {
                checkAdminPassword();
            }
        };

        // Función para previsualizar imágenes
        window.previewImages = function() {
            const fileInput = document.getElementById('product-images');
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';

            if (fileInput.files.length === 0) {
                return;
            }

            if (fileInput.files.length > 10) {
                alert('Solo puedes seleccionar un máximo de 10 imágenes');
                fileInput.value = '';
                return;
            }

            Array.from(fileInput.files).forEach((file, index) => {
                // Verificar que sea una imagen
                if (!file.type.startsWith('image/')) {
                    alert(`El archivo ${file.name} no es una imagen válida`);
                    return;
                }

                // Verificar tamaño
                if (file.size > 2 * 1024 * 1024) {
                    alert(`La imagen ${file.name} es demasiado grande (máximo 2MB)`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgContainer = document.createElement('div');
                    imgContainer.style.cssText = 'position: relative; display: inline-block;';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    img.title = file.name;
                    
                    // Botón para eliminar imagen individual
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '×';
                    removeBtn.style.cssText = `
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        background: #ff4444;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 20px;
                        height: 20px;
                        cursor: pointer;
                        font-size: 14px;
                        line-height: 1;
                    `;
                    removeBtn.onclick = () => removeImageFromPreview(index);
                    
                    imgContainer.appendChild(img);
                    imgContainer.appendChild(removeBtn);
                    preview.appendChild(imgContainer);
                };
                reader.onerror = function() {
                    alert(`Error al cargar la imagen ${file.name}`);
                };
                reader.readAsDataURL(file);
            });
        };

        // Función para eliminar una imagen específica de la previsualización
        window.removeImageFromPreview = function(indexToRemove) {
            const fileInput = document.getElementById('product-images');
            const dt = new DataTransfer();
            
            Array.from(fileInput.files).forEach((file, index) => {
                if (index !== indexToRemove) {
                    dt.items.add(file);
                }
            });
            
            fileInput.files = dt.files;
            previewImages();
        };

        // Función para mostrar loading en admin
        function showAdminLoading(show = true) {
            const loading = document.getElementById('admin-loading');
            loading.style.display = show ? 'flex' : 'none';
        }

        // Función para añadir producto a Firebase
        async function addProductToFirebase(productData) {
            try {
                const docRef = await addDoc(collection(db, "products"), {
                    ...productData,
                    dateAdded: serverTimestamp()
                });
                console.log("Product added with ID: ", docRef.id);
                return true;
            } catch (error) {
                console.error("Error adding product: ", error);
                throw error;
            }
        }

        // Función para eliminar producto de Firebase
        window.deleteProduct = async function(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (confirm(`¿Estás seguro de que quieres eliminar "${product.name}"?\n\nEsta acción no se puede deshacer.`)) {
                try {
                    await deleteDoc(doc(db, "products", productId));
                    showNotification('Producto eliminado correctamente', 'success');
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showNotification('Error al eliminar el producto', 'error');
                }
            }
        };

        // Función para mostrar notificaciones
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#48bb78' : '#e53e3e'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-weight: bold;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Función para cargar productos en el panel admin
        function loadAdminProducts() {
            showAdminLoading(true);
            
            const q = query(collection(db, "products"), orderBy("dateAdded", "desc"));
            onSnapshot(q, (querySnapshot) => {
                products = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    products.push({
                        id: doc.id,
                        ...data
                    });
                });
                displayAdminProducts();
                showAdminLoading(false);
            }, (error) => {
                console.error("Error loading admin products:", error);
                showAdminLoading(false);
                showNotification('Error al cargar los productos', 'error');
            });
        }

        function displayAdminProducts() {
            const container = document.getElementById('admin-products-list');
            
            if (products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No hay productos añadidos aún.</p>';
                return;
            }
            
            container.innerHTML = products.map(product => {
                const dateAdded = product.dateAdded ? 
                    (product.dateAdded.toDate ? product.dateAdded.toDate().toLocaleDateString('es-ES') : 
                     new Date(product.dateAdded).toLocaleDateString('es-ES')) : 
                    'No disponible';
                
                return `
                    <div class="product-item">
                        <h4>${product.name}</h4>
                        <p><strong>Precio:</strong> ${product.price.toFixed(2)}€</p>
                        <p><strong>Imágenes:</strong> ${product.images ? product.images.length : 0}</p>
                        <p><strong>Fecha añadido:</strong> ${dateAdded}</p>
                        <p><strong>Enlace:</strong> <a href="${product.wallapopLink}" target="_blank" style="color: #667eea;">Ver en Wallapop</a></p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">
                                Eliminar Producto
                            </button>
                            <button class="btn" onclick="viewProduct('${product.id}')" style="background: #4a5568;">
                                Ver Detalles
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Función para ver detalles del producto
        window.viewProduct = function(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const images = (product.images || []).map((img, index) => 
                `<img src="${img}" alt="${product.name}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px; margin: 5px;">`
            ).join('');
            
            const dateAdded = product.dateAdded ? 
                (product.dateAdded.toDate ? product.dateAdded.toDate().toLocaleDateString('es-ES') : 
                 new Date(product.dateAdded).toLocaleDateString('es-ES')) : 
                'No disponible';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <span class="close-btn" onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #999;">&times;</span>
                    <h2>${product.name}</h2>
                    <p><strong>Precio:</strong> ${product.price.toFixed(2)}€</p>
                    <p><strong>Fecha añadido:</strong> ${dateAdded}</p>
                    <p><strong>Enlace Wallapop:</strong> <a href="${product.wallapopLink}" target="_blank">${product.wallapopLink}</a></p>
                    <div style="margin: 20px 0;">
                        <strong>Imágenes (${product.images ? product.images.length : 0}):</strong>
                        <div style="margin-top: 10px;">
                            ${images}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            };
        };

        // Configurar el formulario
        document.addEventListener('DOMContentLoaded', function() {
            const productForm = document.getElementById('product-form');
            
            productForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('product-name').value.trim();
                const price = parseFloat(document.getElementById('product-price').value);
                const wallapopLink = document.getElementById('wallapop-link').value.trim();
                const imageFiles = document.getElementById('product-images').files;
                
                // Validaciones
                if (!name || !price || !wallapopLink) {
                    alert('Por favor, completa todos los campos obligatorios');
                    return;
                }
                
                if (price <= 0) {
                    alert('El precio debe ser mayor que 0');
                    return;
                }
                
                if (imageFiles.length === 0) {
                    alert('Por favor, añade al menos una imagen');
                    return;
                }
                
                // Validar que el enlace sea de Wallapop
                if (!wallapopLink.includes('wallapop.com')) {
                    if (!confirm('El enlace no parece ser de Wallapop. ¿Continuar de todos modos?')) {
                        return;
                    }
                }
                
                const images = [];
                let processedImages = 0;
                const maxImages = 10;
                
                if (imageFiles.length > maxImages) {
                    alert(`Solo puedes subir un máximo de ${maxImages} imágenes`);
                    return;
                }
                
                // Mostrar indicador de carga
                const submitBtn = productForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Procesando...';
                submitBtn.disabled = true;
                
                try {
                    // Convertir imágenes a base64
                    for (let i = 0; i < imageFiles.length; i++) {
                        const file = imageFiles[i];
                        
                        // Verificar tamaño del archivo
                        if (file.size > 2 * 1024 * 1024) {
                            throw new Error(`La imagen ${file.name} es demasiado grande. Máximo 2MB por imagen.`);
                        }
                        
                        const base64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = () => reject(new Error(`Error al procesar ${file.name}`));
                            reader.readAsDataURL(file);
                        });
                        
                        images.push(base64);
                        processedImages++;
                        submitBtn.textContent = `Procesando... ${processedImages}/${imageFiles.length}`;
                    }
                    
                    // Crear objeto del producto
                    const productData = {
                        name,
                        price,
                        wallapopLink,
                        images
                    };
                    
                    // Añadir a Firebase
                    await addProductToFirebase(productData);
                    
                    // Resetear formulario
                    productForm.reset();
                    document.getElementById('image-preview').innerHTML = '';
                    
                    showNotification('Producto añadido correctamente');
                    window.scrollTo(0, 0);
                    
                } catch (error) {
                    console.error('Error adding product:', error);
                    showNotification(error.message || 'Error al añadir el producto', 'error');
                } finally {
                    // Restaurar botón
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Enfocar el campo de contraseña al cargar la página
            document.getElementById('admin-password').focus();
        });

        // Añadir animación de shake para el error de contraseña
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            
            .loading {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                color: #666;
            }

            .loading-spinner {
                width: 30px;
                height: 30px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 15px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }`